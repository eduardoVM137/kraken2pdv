<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario Producto Completo</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h2 { margin-top: 40px; }
    fieldset, .block { background: #fff; margin-bottom: 20px; padding: 20px; border-radius: 10px; border: 1px solid #ccc; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #aaa; }
    th, td { padding: 8px; text-align: left; }
    button { margin-top: 10px; padding: 8px 16px; }
  </style>
</head>
<body>

<h1>Captura de Producto Completa</h1>

<!-- DETALLE PRODUCTO -->
<div class="block">
  <h2>Detalle del Producto</h2>
  <input type="number" id="producto_id" placeholder="Producto ID" value="1">
  <input type="text" id="marca_id" placeholder="Marca ID" value="PEPSI">
  <input type="text" id="medida" placeholder="Medida" value="1.00">
  <input type="text" id="unidad_medida" placeholder="Unidad de medida" value="lt">
  <textarea id="descripcion" placeholder="Descripci√≥n"></textarea>
  <input type="text" id="nombre_calculado" placeholder="Nombre calculado" value="Pepsi 1L retornable">
  <label>¬øActivo?</label>
  <select id="activo">
    <option value="true" selected>S√≠</option>
    <option value="false">No</option>
  </select>
</div>

 <!-- ATRIBUTOS DEL PRODUCTO -->
<div class="block">
  <h2>Atributos del producto</h2>
  <input type="text" id="atributo" placeholder="Atributo">
  <input type="text" id="nombre_atributo" placeholder="Nombre Atributo">
  <input type="text" id="valor_atributo" placeholder="Valor Atributo">
  <button type="button" onclick="agregarAtributo()">Agregar Atributo</button>

  <table id="tablaAtributos">
    <thead><tr><th>Nombre</th><th>Valor</th><th>Eliminar</th></tr></thead>
    <tbody></tbody>
  </table>
</div>


<!-- PRESENTACIONES -->
<div class="block">
  <h2>Presentaciones</h2>
  <input type="text" id="nombrePresentacion" placeholder="Nombre">
  <input type="number" id="cantidadPresentacion" placeholder="Cantidad">
  <button type="button" onclick="agregarPresentacion()">Agregar Presentaci√≥n</button>

  <table id="tablaPresentaciones">
    <thead><tr><th>Nombre</th><th>Cantidad</th><th>ID Virtual</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- ALIAS / EANs -->
<div class="block">
  <h2>Alias vinculados a presentaci√≥n</h2>
  <input type="text" id="alias" placeholder="EAN o Alias">
  <select id="selectPresentacion">
    <option value="">Sin presentaci√≥n</option>
  </select>
  <button type="button" onclick="agregarAlias()">Agregar Alias</button>

  <table id="tablaAlias">
    <thead><tr><th>Alias</th><th>Presentaci√≥n Asociada</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- PRECIOS -->
<div class="block">
  <h2>Precios</h2>
  <input type="text" id="precio_venta" placeholder="Precio venta">
  <input type="text" id="cantidad_minima" placeholder="Cantidad m√≠nima">
  <input type="text" id="tipo_cliente_id" placeholder="Tipo cliente ID">
  <input type="text" id="descripcion_precio" placeholder="Descripci√≥n del precio">
  <select id="selectPresentacionPrecio">
    <option value="">Sin presentaci√≥n</option>
  </select>
  <button type="button" onclick="agregarPrecio()">Agregar Precio</button>

  <table id="tablaPrecios">
    <thead><tr><th>Precio</th><th>M√≠nimo</th><th>Tipo Cliente</th><th>Presentaci√≥n</th><th>ID Virtual</th></tr></thead>
    <tbody></tbody>
  </table>
</div>


<!-- INVENTARIOS -->
<div class="block">
  <h2>Inventarios</h2>
  <input type="text" id="stock_actual" placeholder="Stock actual">
  <input type="text" id="stock_minimo" placeholder="Stock m√≠nimo">
  <input type="text" id="precio_costo" placeholder="Precio costo">
  <input type="number" id="ubicacion_fisica_id" placeholder="Ubicaci√≥n f√≠sica ID">
  <button type="button" onclick="agregarInventario()">Agregar Inventario</button>

  <table id="tablaInventarios">
    <thead><tr><th>Stock</th><th>M√≠nimo</th><th>Precio costo</th><th>Ubicaci√≥n</th><th>ID Virtual</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- UBICACIONES DE PRODUCTO -->
<div class="block">
  <h2>Ubicaciones del Producto</h2>
  <input type="text" id="negocio_id" placeholder="Negocio ID">
  <input type="text" id="ubicacion_fisica_up" placeholder="Ubicaci√≥n f√≠sica ID">
  <select id="selectInventarioVirtual">
    <option value="">Sin inventario</option>
  </select>
  <select id="selectPrecioVirtual">
    <option value="">Sin precio</option>
  </select>
  <select id="selectCompartir">
    <option value="true">Compartir</option>
    <option value="false">No compartir</option>
  </select>
  <button type="button" onclick="agregarUbicacion()">Agregar Ubicaci√≥n</button>

  <table id="tablaUbicaciones">
    <thead><tr><th>Negocio</th><th>Ubicaci√≥n</th><th>Inventario</th><th>Precio</th><th>Compartir</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- FOTOS -->
<div class="block">
  <h2>Fotos</h2>
  <input type="url" id="foto1" placeholder="URL de la foto 1" value="https://miapp.com/img/pepsi-1.jpg">
  <input type="url" id="foto2" placeholder="URL de la foto 2" value="https://miapp.com/img/pepsi-1-sec.jpg">
</div>

 <!-- COMPONENTES -->
<div class="block">
  <h2>Componentes del producto</h2>
  <input type="number" id="componente_padre_id" placeholder="ID Producto Padre">
  <input type="text" id="componente_cantidad" placeholder="Cantidad">
  <button type="button" onclick="agregarComponente()">Agregar Componente</button>

  <table id="tablaComponentes">
    <thead><tr><th>ID Padre</th><th>Cantidad</th><th>Eliminar</th></tr></thead>
    <tbody></tbody>
  </table>
</div>




<button onclick="enviarDatos()">Enviar al servidor</button>
 
 <script>
  
  function eliminarIdVirtual(idVirtual) {
  // 1. Eliminar de presentaciones
  const indexPres = presentacionesTemp.findIndex(p => p.idVirtualPresentacion === idVirtual);
  if (indexPres !== -1) {
    presentacionesTemp.splice(indexPres, 1);
    actualizarTablaPresentaciones();
    actualizarSelectPresentaciones();
  }

  // 2. Eliminar de precios
  const indexPrecio = preciosTemp.findIndex(p => p.idVirtual === idVirtual);
  if (indexPrecio !== -1) {
    preciosTemp.splice(indexPrecio, 1);
    actualizarTablaPrecios();
    actualizarSelectPrecios();
  }

  // 3. Eliminar de inventarios
  const indexInv = inventariosTemp.findIndex(i => i.idVirtual === idVirtual);
  if (indexInv !== -1) {
    inventariosTemp.splice(indexInv, 1);
    actualizarTablaInventarios();
    actualizarSelectInventarios();
  }

  // 4. Eliminar de alias
  const indexAlias = aliasTemp.findIndex(a => a.idVirtual === idVirtual);
  if (indexAlias !== -1) {
    aliasTemp.splice(indexAlias, 1);
    actualizarTablaAlias();
  }

  // 5. Eliminar de ubicaciones
  const indexUbic = ubicacionesTemp.findIndex(u => u.idVirtual === idVirtual);
  if (indexUbic !== -1) {
    ubicacionesTemp.splice(indexUbic, 1);
    actualizarTablaUbicaciones();
  }

  // üîÅ Reemplazar referencias cruzadas con null (N/A)
  aliasTemp.forEach(a => {
    if (a.idVirtualPresentacion === idVirtual) a.idVirtualPresentacion = null;
  });

  preciosTemp.forEach(p => {
    if (p.idVirtualPresentacion === idVirtual) p.idVirtualPresentacion = null;
  });

  ubicacionesTemp.forEach(u => {
    if (u.idVirtualInventario === idVirtual) u.idVirtualInventario = null;
    if (u.idVirtualPrecio === idVirtual) u.idVirtualPrecio = null;
  });

  // Actualizar tablas que dependen de alias/presentaci√≥n/precio/inventario
  actualizarTablaAlias();
  actualizarTablaPrecios();
  actualizarTablaUbicaciones();
}

  
  const presentacionesTemp = [];
  const aliasTemp = [];
  const preciosTemp = [];
  const inventariosTemp = [];
  const ubicacionesTemp = []; 
  const generateVirtualId = (prefix) => `${prefix}_${crypto.randomUUID().slice(0, 8)}`;

  // PRESENTACIONES
  function agregarPresentacion() {
    const nombre = document.getElementById('nombrePresentacion').value;
    const cantidad = document.getElementById('cantidadPresentacion').value;
    if (!nombre || !cantidad) return alert("Completa nombre y cantidad.");
    const idVirtual = generateVirtualId('pres');
    presentacionesTemp.push({ nombre, cantidad, idVirtualPresentacion: idVirtual });
    actualizarTablaPresentaciones();
    actualizarSelectPresentaciones();
    document.getElementById('nombrePresentacion').value = '';
    document.getElementById('cantidadPresentacion').value = '';
  }
  function actualizarTablaPresentaciones() {
  const tbody = document.querySelector('#tablaPresentaciones tbody');
  tbody.innerHTML = presentacionesTemp.map((p, i) => `
    <tr>
      <td>${p.nombre}</td>
      <td>${p.cantidad}</td>
      <td>${p.idVirtualPresentacion}</td>
      <td><button onclick="eliminarIdVirtual('${p.idVirtualPresentacion}')">‚ùå</button></td>
    </tr>
  `).join('');
}
function eliminarPresentacion(index) {
  presentacionesTemp.splice(index, 1);
  actualizarTablaPresentaciones();
  actualizarSelectPresentaciones();
}
  function actualizarSelectPresentaciones() {
    ['selectPresentacion', 'selectPresentacionPrecio'].forEach(id => {
      const sel = document.getElementById(id);
      sel.innerHTML = '<option value="">Sin presentaci√≥n</option>';
      presentacionesTemp.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.idVirtualPresentacion;
        opt.textContent = `${p.nombre} (${p.cantidad})`;
        sel.appendChild(opt);
      });
    });
  }

  // ALIAS
  function agregarAlias() {
    const alias = document.getElementById('alias').value;
    const idVirtualPresentacion = document.getElementById('selectPresentacion').value;
    if (!alias) return alert("Ingresa un alias.");
    aliasTemp.push({
      alias,
      tipo: 'ean',
      visible: true,
      idVirtualPresentacion: idVirtualPresentacion || null
    });
    actualizarTablaAlias();
    document.getElementById('alias').value = '';
  }
  function actualizarTablaAlias() {
  const tbody = document.querySelector('#tablaAlias tbody');
  tbody.innerHTML = aliasTemp.map((a, i) => `
    <tr>
      <td>${a.alias}</td>
      <td>${a.tipo}</td>
      <td>${a.visible}</td>
      <td>${a.idVirtualPresentacion || 'N/A'}</td>
      <td><button onclick="eliminarAlias(${i})">‚ùå</button></td>
    </tr>
  `).join('');
}
function eliminarAlias(index) {
  aliasTemp.splice(index, 1);
  actualizarTablaAlias();
}
  // PRECIOS
  function agregarPrecio() {
    const precio_venta = document.getElementById('precio_venta').value;
    const cantidad_minima = document.getElementById('cantidad_minima').value;
    const tipo_cliente_id = document.getElementById('tipo_cliente_id').value;
    const descripcion = document.getElementById('descripcion_precio').value;
    const idVirtualPresentacion = document.getElementById('selectPresentacionPrecio').value;
    if (!precio_venta || !tipo_cliente_id) return alert("Completa los campos de precio.");
    const idVirtual = generateVirtualId('precio');
    preciosTemp.push({
      idVirtual,
      precio_venta,
      cantidad_minima,
      tipo_cliente_id,
      descripcion,
      idVirtualPresentacion: idVirtualPresentacion || null
    });
    actualizarTablaPrecios();
    actualizarSelectPrecios();
  }
  function actualizarTablaPrecios() {
  const tbody = document.querySelector('#tablaPrecios tbody');
  tbody.innerHTML = preciosTemp.map((p, i) => `
    <tr>
      <td>${p.precio_venta}</td>
      <td>${p.cantidad_minima}</td>
      <td>${p.tipo_cliente_id}</td>
      <td>${p.idVirtualPresentacion || 'N/A'}</td>  <!-- esta l√≠nea muestra presentaci√≥n -->
      <td>${p.idVirtual}</td>                        <!-- esta l√≠nea muestra ID del precio -->
      <td><button onclick="eliminarIdVirtual('${p.idVirtual}')">‚ùå</button></td>
    </tr>
  `).join('');
}

function eliminarPrecio(index) {
  preciosTemp.splice(index, 1);
  actualizarTablaPrecios();
  actualizarSelectPrecios();
}
  function actualizarSelectPrecios() {
    const sel = document.getElementById('selectPrecioVirtual');
    sel.innerHTML = '<option value="">Sin precio</option>';
    preciosTemp.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.idVirtual;
      opt.textContent = `Precio $${p.precio_venta}`;
      sel.appendChild(opt);
    });
  }

  // INVENTARIOS
  function agregarInventario() {
    const stock_actual = document.getElementById('stock_actual').value;
    const stock_minimo = document.getElementById('stock_minimo').value;
    const precio_costo = document.getElementById('precio_costo').value;
    const ubicacion_fisica_id = document.getElementById('ubicacion_fisica_id').value;
    if (!stock_actual || !precio_costo || !ubicacion_fisica_id) return alert("Campos de inventario incompletos.");
    const idVirtual = generateVirtualId('inv');
    inventariosTemp.push({ idVirtual, stock_actual, stock_minimo, precio_costo, ubicacion_fisica_id });
    actualizarTablaInventarios();
    actualizarSelectInventarios();
  }
  function actualizarTablaInventarios() {
  const tbody = document.querySelector('#tablaInventarios tbody');
  tbody.innerHTML = inventariosTemp.map((i, idx) => `
    <tr>
      <td>${i.stock_actual}</td>
      <td>${i.stock_minimo}</td>
      <td>${i.precio_costo}</td>
      <td>${i.ubicacion_fisica_id}</td>
      <td>${i.idVirtual}</td>
      <td><button onclick="eliminarIdVirtual('${i.idVirtual}')">‚ùå</button></td>

    </tr>
  `).join('');
}
function eliminarInventario(index) {
  inventariosTemp.splice(index, 1);
  actualizarTablaInventarios();
  actualizarSelectInventarios();
}
  function actualizarSelectInventarios() {
    const sel = document.getElementById('selectInventarioVirtual');
    sel.innerHTML = '<option value="">Sin inventario</option>';
    inventariosTemp.forEach(i => {
      const opt = document.createElement('option');
      opt.value = i.idVirtual;
      opt.textContent = `Inventario ${i.idVirtual}`;
      sel.appendChild(opt);
    });
  }

  // UBICACIONES
  function agregarUbicacion() {
    const negocio_id = document.getElementById('negocio_id').value;
    const ubicacion_fisica_id = document.getElementById('ubicacion_fisica_up').value;
    const idVirtualInventario = document.getElementById('selectInventarioVirtual').value;
    const idVirtualPrecio = document.getElementById('selectPrecioVirtual').value;
    const compartir = document.getElementById('selectCompartir').value === 'true';
    if (!negocio_id || !ubicacion_fisica_id) return alert("Campos de ubicaci√≥n incompletos.");
    ubicacionesTemp.push({
      negocio_id,
      ubicacion_fisica_id,
      idVirtualInventario: idVirtualInventario || null,
      idVirtualPrecio: idVirtualPrecio || null,
      compartir
    });
    actualizarTablaUbicaciones();
  }
  function actualizarTablaUbicaciones() {
  const tbody = document.querySelector('#tablaUbicaciones tbody');
  tbody.innerHTML = ubicacionesTemp.map((u, idx) => `
    <tr>
      <td>${u.negocio_id}</td>
      <td>${u.ubicacion_fisica_id}</td>
      <td>${u.idVirtualInventario || 'N/A'}</td>
      <td>${u.idVirtualPrecio || 'N/A'}</td>
      <td>${u.compartir}</td>
      <td><button onclick="eliminarUbicacion(${idx})">‚ùå</button></td>
    </tr>
  `).join('');
}
function eliminarUbicacion(index) {
  ubicacionesTemp.splice(index, 1);
  actualizarTablaUbicaciones();
}


  const componentesTemp = [];
const detallesAtributoTemp = [];

// COMPONENTES
function agregarComponente() {
  const padreId = parseInt(document.getElementById('componente_padre_id').value);
  const cantidad = document.getElementById('componente_cantidad').value;

  if (!padreId || !cantidad) return alert("Falta ID o cantidad");

  componentesTemp.push({ detalle_producto_padre_id: padreId, cantidad });
  actualizarTablaComponentes();

  document.getElementById('componente_padre_id').value = '';
  document.getElementById('componente_cantidad').value = '';
}

function eliminarComponente(index) {
  componentesTemp.splice(index, 1);
  actualizarTablaComponentes();
}

function actualizarTablaComponentes() {
  const tbody = document.querySelector('#tablaComponentes tbody');
  tbody.innerHTML = componentesTemp.map((c, i) =>
    `<tr><td>${c.detalle_producto_padre_id}</td><td>${c.cantidad}</td><td><button onclick="eliminarComponente(${i})">‚ùå</button></td></tr>`
  ).join('');
}

// ATRIBUTOS
function agregarAtributo() {
  const nombre = document.getElementById('nombre_atributo').value;
  const valor = document.getElementById('valor_atributo').value;

  if (!nombre || !valor) return alert("Falta nombre o valor");

  detallesAtributoTemp.push({ nombre, valor });
  actualizarTablaAtributos();

  document.getElementById('nombre_atributo').value = '';
  document.getElementById('valor_atributo').value = '';
}

function eliminarAtributo(index) {
  detallesAtributoTemp.splice(index, 1);
  actualizarTablaAtributos();
}

function actualizarTablaAtributos() {
  const tbody = document.querySelector('#tablaAtributos tbody');
  tbody.innerHTML = detallesAtributoTemp.map((a, i) =>
    `<tr><td>${a.nombre}</td><td>${a.valor}</td><td><button onclick="eliminarAtributo(${i})">‚ùå</button></td></tr>`
  ).join('');
}


 
function safeGet(id) {
  const el = document.getElementById(id);
  return el ? el.value : null;
}

function generarJSONFinal() {
  return {
    producto_id: safeGet('producto_id'),
    marca_id: safeGet('marca_id'),
    medida: safeGet('medida'),
    unidad_medida: safeGet('unidad_medida'),
    descripcion: safeGet('descripcion'),
    nombre_calculado: safeGet('nombre_calculado'),
    activo: safeGet('activo') === 'true',

    // Corregido: atributo como objeto
    atributo: {
      nombre: safeGet('atributo_nombre')
    },

    // Solo valores, no nombres
    detalles_atributo: detallesAtributoTemp.map(a => ({
      valor: a.valor
    })),

    // Listas din√°micas ya controladas
    presentaciones: presentacionesTemp,
    etiquetas: aliasTemp.map(e => ({
      ...e,
      idVirtualPresentacion: e.idVirtualPresentacion || null
    })),
    precios: preciosTemp.map(p => ({
      ...p,
      idVirtualPresentacion: p.idVirtualPresentacion || null
    })),
    inventarios: inventariosTemp.map(i => ({
      ...i
    })),
    producto_ubicaciones: ubicacionesTemp.map(u => ({
      ...u,
      idVirtualInventario: u.idVirtualInventario || null,
      idVirtualPrecio: u.idVirtualPrecio || null
    })),

    fotos: [
      safeGet('foto1'),
      safeGet('foto2')
    ].filter(f => f), // filtra vac√≠os

    componentes: componentesTemp
  };
}


 
 
  // ENVIAR
  async function enviarDatos() {
    const json = generarJSONFinal();
    console.log("üì¶ Enviando JSON:", json);
    try {
      const res = await fetch('http://localhost:3000/api/detalle-producto', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(json)
      });
      const data = await res.json();
      console.log("‚úÖ Respuesta del servidor:", data);
      alert("Producto enviado con √©xito");
    } catch (err) {
      console.error("‚ùå Error:", err);
      alert("Ocurri√≥ un error al enviar");
    }
  } 
</script>

</body>
</html>
